<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹æ–‡å½¢éŸ³ç¾©é—–é—œæŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-user-select: none; touch-action: manipulation; }
        .fixed-bottom { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; }
        .btn-active:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <nav class="bg-indigo-600 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-40">
        <div>
            <h1 class="font-bold text-lg leading-none">å½¢éŸ³ç¾©å¤§æŒ‘æˆ°</h1>
            <p id="level-indicator" class="text-xs opacity-80 mt-1">è®€å–é¡Œåº«ä¸­...</p>
        </div>
        <div id="progress-tag" class="hidden bg-indigo-800 px-3 py-1 rounded-full text-sm font-mono">0 / 10</div>
    </nav>

    <main class="container mx-auto p-4 max-w-md">
        
        <div id="map-screen" class="space-y-6">
            <div class="bg-blue-100 p-3 rounded-lg text-blue-800 text-sm mb-4">
                ğŸ’¡ æ¯å€‹é¡åˆ¥éœ€é”åˆ° 80% æ­£ç¢ºç‡å³å¯è§£é–ä¸‹ä¸€ç´šã€‚
            </div>
            
            <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="font-bold text-indigo-600 mb-4 flex items-center">å­—å½¢ (SF)</h2>
                <div class="flex gap-4" id="sf-levels"></div>
            </section>

            <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="font-bold text-emerald-600 mb-4 flex items-center">å­—éŸ³ (SD)</h2>
                <div class="flex gap-4" id="sd-levels"></div>
            </section>

            <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="font-bold text-orange-600 mb-4 flex items-center">å­—ç¾© (MN)</h2>
                <div class="flex gap-4" id="mn-levels"></div>
            </section>
        </div>

        <div id="quiz-screen" class="hidden py-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-6 min-h-[120px] flex items-center justify-center">
                <div id="question-text" class="text-xl font-bold text-center leading-relaxed">è¼‰å…¥ä¸­...</div>
            </div>
            <div id="options-grid" class="grid grid-cols-1 gap-4"></div>
        </div>

        <div id="result-screen" class="hidden text-center py-12 space-y-8">
            <div id="result-emoji" class="text-8xl">ğŸŠ</div>
            <h2 id="result-title" class="text-3xl font-black text-slate-900">æŒ‘æˆ°æˆåŠŸï¼</h2>
            <p id="result-desc" class="text-slate-500 mt-2 text-lg font-medium"></p>
            <div class="flex flex-col gap-4 px-6">
                <button id="next-level-btn" onclick="restartOrNext()" class="bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl btn-active">æŒ‘æˆ°ä¸‹ä¸€é—œ</button>
                <button onclick="goHome()" class="bg-white text-slate-500 py-4 rounded-2xl font-bold border border-slate-200 btn-active">å›åˆ°åœ°åœ–</button>
            </div>
        </div>
    </main>

    <div id="note-panel" class="fixed-bottom bg-white border-t p-5 transform translate-y-full transition-transform duration-300 shadow-2xl">
        <div class="flex flex-col space-y-4">
            <div class="flex items-center">
                <div id="note-badge" class="px-2 py-0.5 rounded text-xs font-bold mr-2">æ­£ç¢º</div>
                <div id="note-content" class="text-slate-700 font-medium text-sm"></div>
            </div>
            <button onclick="nextQuestion()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold btn-active">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <script>
        // --- è«‹æ›´æ›ç‚ºã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€çš„ CSV é€£çµ ---
        const CSV_URL = https://docs.google.com/spreadsheets/d/e/2PACX-1vSM7wqwBK2VVRNeYJQoRHq94GiySwkGOP68ywRsy699w-MAcHDmNkRo5OuU84cRIZ7MjnMsjNmqF5DA/pub?gid=0&single=true&output=csv;

        let allQuestions = [];
        let currentQuiz = [];
        let currentIndex = 0;
        let correctCount = 0;
        let unlocked = JSON.parse(localStorage.getItem('unlocked_levels_v2')) || { SF: 1, SD: 1, MN: 1 };

        async function initApp() {
            try {
                const response = await fetch(CSV_URL);
                const data = await response.text();
                parseCSV(data);
                renderMap();
                document.getElementById('level-indicator').innerText = "è«‹é¸æ“‡é—œå¡";
            } catch (err) {
                document.getElementById('level-indicator').innerText = "é¡Œåº«é€£ç·šå¤±æ•—";
                alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª Google è¡¨æ ¼æ˜¯å¦å·²ç™¼ä½ˆç‚º CSVã€‚");
            }
        }

        function parseCSV(text) {
            const rows = text.split(/\r?\n/).filter(row => row.trim() !== "");
            const delimiter = text.includes('\t') ? '\t' : ',';
            allQuestions = rows.slice(1).map(row => {
                const cols = row.split(delimiter);
                return {
                    id: cols[0], cat: cols[1], level: parseInt(cols[2]),
                    q: cols[3], opts: [cols[4], cols[5], cols[6], cols[7]], 
                    correct: cols[8]?.trim(), note: cols[9]
                };
            }).filter(q => q.q);
        }

        function renderMap() {
            ['SF', 'SD', 'MN'].forEach(cat => {
                const container = document.getElementById(`${cat.toLowerCase()}-levels`);
                container.innerHTML = '';
                for (let i = 1; i <= 3; i++) {
                    const isLocked = i > unlocked[cat];
                    const btn = document.createElement('button');
                    btn.className = `w-14 h-14 rounded-2xl font-black text-xl transition-all btn-active ${isLocked ? 'bg-slate-100 text-slate-300' : 'bg-white border-2 border-indigo-100 text-indigo-600 shadow-sm'}`;
                    btn.innerHTML = isLocked ? 'ğŸ”’' : i;
                    if (!isLocked) btn.onclick = () => startQuiz(cat, i);
                    container.appendChild(btn);
                }
            });
        }

        function startQuiz(cat, level) {
            const filtered = allQuestions.filter(q => q.cat === cat && q.level === level);
            currentQuiz = filtered.sort(() => Math.random() - 0.5).slice(0, 10);
            if(currentQuiz.length === 0) return alert("æ­¤ç­‰ç´šæš«ç„¡é¡Œç›®ï¼");
            currentIndex = 0; correctCount = 0;
            document.getElementById('level-indicator').innerText = `${cat} - Level ${level}`;
            showScreen('quiz'); loadQuestion();
        }

        function loadQuestion() {
            const q = currentQuiz[currentIndex];
            document.getElementById('progress-tag').innerText = `${currentIndex + 1} / ${currentQuiz.length}`;
            document.getElementById('progress-tag').classList.remove('hidden');
            document.getElementById('question-text').innerText = q.q;
            const grid = document.getElementById('options-grid'); grid.innerHTML = '';
            q.opts.forEach(opt => {
                if(!opt) return;
                const btn = document.createElement('button');
                btn.className = "bg-white border border-slate-200 p-4 rounded-2xl text-left font-medium btn-active shadow-sm";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, q.correct, q.note, btn);
                grid.appendChild(btn);
            });
            hideNote();
        }

        function checkAnswer(selected, correct, note, btn) {
            const isCorrect = selected.includes(correct) || selected === correct;
            const badge = document.getElementById('note-badge');
            if (isCorrect) {
                correctCount++;
                btn.classList.add('bg-emerald-50', 'border-emerald-500', 'text-emerald-700');
                badge.innerText = "æ­£ç¢º"; badge.className = "px-2 py-0.5 rounded text-xs font-bold mr-2 bg-emerald-100 text-emerald-700";
            } else {
                btn.classList.add('bg-rose-50', 'border-rose-500', 'text-rose-700');
                badge.innerText = "éŒ¯èª¤"; badge.className = "px-2 py-0.5 rounded text-xs font-bold mr-2 bg-rose-100 text-rose-700";
            }
            document.getElementById('note-content').innerText = note || "åŠ æ²¹ï¼";
            showNote();
            Array.from(document.getElementById('options-grid').children).forEach(b => b.onclick = null);
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuiz.length) loadQuestion(); else finishQuiz();
        }

        function finishQuiz() {
            const accuracy = correctCount / currentQuiz.length;
            const cat = currentQuiz[0].cat; const level = currentQuiz[0].level;
            showScreen('result');
            document.getElementById('progress-tag').classList.add('hidden');
            document.getElementById('result-desc').innerText = `æ­£ç¢ºç‡ ${accuracy * 100}% (${correctCount}/${currentQuiz.length})`;
            if (accuracy >= 0.8) {
                document.getElementById('result-title').innerText = "æŒ‘æˆ°æˆåŠŸï¼";
                if (level === unlocked[cat] && level < 3) unlocked[cat]++;
                localStorage.setItem('unlocked_levels_v2', JSON.stringify(unlocked));
            } else {
                document.getElementById('result-title').innerText = "å†è©¦ä¸€æ¬¡ï¼";
            }
        }

        function showScreen(type) {
            document.getElementById('map-screen').classList.toggle('hidden', type !== 'map');
            document.getElementById('quiz-screen').classList.toggle('hidden', type !== 'quiz');
            document.getElementById('result-screen').classList.toggle('hidden', type !== 'result');
        }

        function showNote() { document.getElementById('note-panel').classList.remove('translate-y-full'); }
        function hideNote() { document.getElementById('note-panel').classList.add('translate-y-full'); }
        function goHome() { renderMap(); showScreen('map'); }
        function restartOrNext() {
            const cat = currentQuiz[0].cat; const level = currentQuiz[0].level;
            if (correctCount / currentQuiz.length >= 0.8 && level < 3) startQuiz(cat, level + 1);
            else startQuiz(cat, level);
        }

        window.onload = initApp;
    </script>
</body>
</html>
