<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èªæ—çµäºº - æœƒè€ƒåœ‹æ–‡ç‰¹è¨“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --cream: #FDFBF7; --hunter-green: #3E5C3E; }
        body { background-color: var(--cream); color: #2D3748; -webkit-user-select: none; touch-action: manipulation; }
        .hunter-card { background: white; border-bottom: 4px solid #E2E8F0; transition: all 0.2s; }
        .option-btn:active { transform: scale(0.95); }
        .btn-correct { background-color: #F0FFF4 !important; border-color: #68D391 !important; color: #276749 !important; }
        .btn-wrong { background-color: #FFF5F5 !important; border-color: #FC8181 !important; color: #9B2C2C !important; }
        .fixed-bottom { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; }
    </style>
</head>
<body>

    <nav class="bg-[#3E5C3E] text-white p-4 sticky top-0 shadow-md z-40">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <div>
                <h1 class="font-bold text-lg tracking-widest">èªæ—çµäºº</h1>
                <p id="sub-status" class="text-[10px] opacity-80">çµæ•çŸ¥è­˜é»ä¸­...</p>
            </div>
            <div id="quiz-progress" class="hidden font-mono text-sm bg-[#2D432D] px-3 py-1 rounded-full">0 / 20</div>
        </div>
    </nav>

    <main class="container mx-auto p-4 max-w-md pb-32">
        <div id="start-screen" class="py-10 text-center space-y-8">
            <div class="space-y-2">
                <div class="text-6xl animate-bounce">ğŸ¹</div>
                <h2 class="text-2xl font-black text-[#3E5C3E]">æº–å‚™å¥½é–‹å§‹ç‹©çµäº†å—ï¼Ÿ</h2>
                <p class="text-slate-500 text-sm">æœ¬æ¬¡ä»»å‹™ï¼š20é¡Œéš¨æ©Ÿç‰¹è¨“<br>(å­—éŸ³7 / å­—å½¢7 / å­—ç¾©6)</p>
            </div>
            <button id="start-btn" onclick="startMission()" class="w-full bg-[#D97706] text-white py-4 rounded-2xl font-bold text-xl shadow-lg option-btn opacity-50 cursor-not-allowed" disabled>æ­£åœ¨è¼‰å…¥çµç‰©...</button>
            <p id="load-msg" class="text-xs text-slate-400 font-mono">é€£ç·šä¸­...</p>
        </div>

        <div id="quiz-screen" class="hidden space-y-6">
            <div class="hunter-card p-6 rounded-3xl min-h-[140px] flex items-center justify-center shadow-sm border-2 border-slate-100">
                <div id="q-text" class="text-xl font-bold text-center leading-relaxed"></div>
            </div>
            <div id="opts-grid" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="result-screen" class="hidden text-center py-10 space-y-6">
            <div id="result-icon" class="text-7xl">ğŸ†</div>
            <h2 id="result-score" class="text-6xl font-black text-[#D97706]">0</h2>
            <p id="result-eval" class="text-lg font-medium px-4 text-slate-600"></p>
            <button onclick="location.reload()" class="w-full bg-[#3E5C3E] text-white py-4 rounded-2xl font-bold shadow-lg">å†æ¬¡ç‹©çµ</button>
        </div>
    </main>

    <div id="note-panel" class="fixed-bottom bg-white border-t p-6 transform translate-y-full transition-transform duration-300 shadow-2xl">
        <div class="max-w-md mx-auto space-y-4">
            <div class="flex items-start gap-3 text-left">
                <div id="note-badge" class="mt-1 px-2 py-1 rounded text-[10px] font-black uppercase whitespace-nowrap"></div>
                <div>
                    <h4 class="text-xs font-bold text-slate-400 mb-1">çµäººè§£æ</h4>
                    <p id="note-text" class="text-slate-700 text-sm leading-snug"></p>
                </div>
            </div>
            <button onclick="nextQuestion()" class="w-full bg-[#2D3748] text-white py-4 rounded-2xl font-bold shadow-md">ä¸‹ä¸€å€‹çµç‰©</button>
        </div>
    </div>

    <script>
        // åª½åª½æä¾›çš„ CSV ç¶²å€
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTkqOrUWzTe8S6j13tUucGJuTHj_Lm3KRiciWJtf4SMbWCpg45o6E5KjzsZTxc1S17zoJ__h84aFLCT/pub?gid=0&single=true&output=csv';

        let allDB = [];
        let missionSet = [];
        let currIdx = 0;
        let score = 0;

        async function init() {
            const msg = document.getElementById('load-msg');
            const btn = document.getElementById('start-btn');
            try {
                const res = await fetch(CSV_URL + '&cache=' + Date.now());
                const csv = await res.text();
                parseDB(csv);
                
                if(allDB.length > 0) {
                    msg.innerText = `âœ… çµå ´å·²å°±ç·’ï¼šå·²åµæ¸¬åˆ° ${allDB.length} å€‹çµç‰©`;
                    btn.innerText = "é€²å…¥çµå ´";
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.disabled = false;
                } else {
                    throw new Error("è¡¨æ ¼å…§æ²’æœ‰æœ‰æ•ˆé¡Œç›®");
                }
            } catch (e) {
                msg.innerText = "âŒ è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª Google è¡¨æ ¼æ˜¯å¦ç™¼ä½ˆã€‚";
                console.error(e);
            }
        }

        function parseDB(csv) {
            const rows = csv.split(/\r?\n/).map(r => r.trim()).filter(r => r !== "");
            const sep = ","; 
            
            allDB = rows.slice(1).map(row => {
                // æ­£å‰‡è¡¨é”å¼è™•ç† CSV å¯èƒ½åŒ…å«çš„é€—è™Ÿèˆ‡å¼•è™Ÿ
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length < 9) return null;
                return {
                    id: cols[0],
                    cat: cols[1].toUpperCase(),
                    q: cols[3],
                    opts: [cols[4], cols[5], cols[6], cols[7]],
                    ans: cols[8],
                    note: cols[9] || "ï¼ˆæœ¬é¡Œæš«ç„¡è§£æï¼‰"
                };
            }).filter(q => q && q.q && q.ans);
        }

        function startMission() {
            const sf = allDB.filter(q => q.cat === 'SF').sort(() => 0.5 - Math.random());
            const sd = allDB.filter(q => q.cat === 'SD').sort(() => 0.5 - Math.random());
            const mn = allDB.filter(q => q.cat === 'MN').sort(() => 0.5 - Math.random());

            // æª¢æŸ¥é¡Œç›®æ˜¯å¦è¶³å¤  7-7-6
            if (sf.length < 7 || sd.length < 7 || mn.length < 6) {
                alert(`çµç‰©ä¸è¶³ï¼ç›®å‰åº«å­˜ï¼šå­—éŸ³(SD) ${sd.length}, å­—å½¢(SF) ${sf.length}, å­—ç¾©(MN) ${mn.length}ã€‚å„é¡åˆ¥éœ€è‡³å°‘ 7, 7, 6 é¡Œã€‚`);
                return;
            }

            missionSet = [
                ...sf.slice(0, 7),
                ...sd.slice(0, 7),
                ...mn.slice(0, 6)
            ].sort(() => 0.5 - Math.random());

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('quiz-progress').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const q = missionSet[currIdx];
            document.getElementById('quiz-progress').innerText = `${currIdx + 1} / 20`;
            document.getElementById('q-text').innerText = q.q;
            
            const grid = document.getElementById('opts-grid');
            grid.innerHTML = '';
            q.opts.forEach(opt => {
                if(!opt) return;
                const btn = document.createElement('button');
                btn.className = "hunter-card p-4 rounded-2xl text-left font-medium border-2 border-slate-100 shadow-sm option-btn";
                btn.innerText = opt;
                btn.onclick = () => checkAns(opt, q.ans, q.note, btn);
                grid.appendChild(btn);
            });
            document.getElementById('note-panel').classList.add('translate-y-full');
        }

        function checkAns(selected, correct, note, btn) {
            const isCorrect = selected.trim() === correct.trim() || selected.includes(correct);
            const badge = document.getElementById('note-badge');
            
            Array.from(document.getElementById('opts-grid').children).forEach(b => b.onclick = null);

            if (isCorrect) {
                score += 5;
                btn.classList.add('btn-correct');
                badge.innerText = "æ•ç²æˆåŠŸ";
                badge.className = "mt-1 px-2 py-1 rounded text-[10px] font-black bg-green-100 text-green-700";
            } else {
                btn.classList.add('btn-wrong');
                badge.innerText = "çµç‰©é€ƒè„«";
                badge.className = "mt-1 px-2 py-1 rounded text-[10px] font-black bg-red-100 text-red-700";
                // æ¨™ç¤ºå‡ºæ­£ç¢ºç­”æ¡ˆ
                Array.from(document.getElementById('opts-grid').children).forEach(b => {
                   if(b.innerText.includes(correct)) b.classList.add('border-green-500', 'bg-green-50');
                });
            }
            
            document.getElementById('note-text').innerText = note;
            document.getElementById('note-panel').classList.remove('translate-y-full');
            
            if (currIdx === 19 && isCorrect) {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        }

        function nextQuestion() {
            currIdx++;
            if (currIdx < 20) loadQuestion(); else finish();
        }

        function finish() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('quiz-progress').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('note-panel').classList.add('translate-y-full');
            document.getElementById('result-score').innerText = score + " åˆ†";
            
            let eval = score >= 90 ? "å‚³èªªç´šçµäººï¼æœƒè€ƒ A++ å°±åœ¨çœ¼å‰ï¼" : 
                       score >= 70 ? "å°ˆæ¥­çµäººï¼å†ç·´å¹¾æ¬¡å°±èƒ½æ»¿åˆ†ï¼" : "å¯¦ç¿’çµäººï¼å¤šçœ‹è§£æï¼Œä¸‹æ¬¡æœƒæ›´å¥½ã€‚";
            document.getElementById('result-eval').innerText = eval;
            if(score >= 90) confetti({ particleCount: 200, spread: 100 });
        }

        window.onload = init;
    </script>
</body>
</html>
