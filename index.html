<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>èªæ—çµäºº - æœƒè€ƒåœ‹æ–‡ç‰¹è¨“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --cream: #FDFBF7;
            --hunter-green: #3E5C3E;
            --amber: #D97706;
        }
        body { 
            background-color: var(--cream); 
            color: #2D3748;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        .hunter-card { background: white; border-bottom: 4px solid #E2E8F0; }
        .option-btn { transition: all 0.2s; border: 2px solid #EDF2F7; }
        .option-btn:active { transform: scale(0.98); }
        .btn-correct { background-color: #F0FFF4; border-color: #68D391; color: #276749; }
        .btn-wrong { background-color: #FFF5F5; border-color: #FC8181; color: #9B2C2C; }
        .fixed-bottom { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; }
    </style>
</head>
<body>

    <nav class="bg-[#3E5C3E] text-white p-4 sticky top-0 shadow-md z-40">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <div>
                <h1 class="font-bold text-lg tracking-widest">èªæ—çµäºº</h1>
                <p id="sub-status" class="text-[10px] opacity-80">çµæ•çŸ¥è­˜é»ä¸­...</p>
            </div>
            <div id="quiz-progress" class="hidden font-mono text-sm bg-[#2D432D] px-3 py-1 rounded-full">
                0 / 20
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 max-w-md pb-32">
        <div id="start-screen" class="py-10 text-center space-y-8">
            <div class="space-y-2">
                <div class="text-6xl">ğŸ¹</div>
                <h2 class="text-2xl font-black text-[#3E5C3E]">æº–å‚™å¥½é–‹å§‹ç‹©çµäº†å—ï¼Ÿ</h2>
                <p class="text-slate-500 text-sm">æœ¬æ¬¡ä»»å‹™ï¼š20é¡Œéš¨æ©Ÿç‰¹è¨“<br>(å­—éŸ³7 / å­—å½¢7 / å­—ç¾©6)</p>
            </div>
            <button onclick="startMission()" class="w-full bg-[#D97706] text-white py-4 rounded-2xl font-bold text-xl shadow-lg btn-active">é€²å…¥çµå ´</button>
            <p id="load-msg" class="text-xs text-slate-400">æ­£åœ¨æª¢æŸ¥çµç‰©åº«...</p>
        </div>

        <div id="quiz-screen" class="hidden space-y-6">
            <div class="hunter-card p-6 rounded-3xl min-h-[140px] flex items-center justify-center shadow-sm">
                <div id="q-text" class="text-xl font-bold text-center leading-relaxed"></div>
            </div>
            <div id="opts-grid" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="result-screen" class="hidden text-center py-10 space-y-6">
            <div id="result-icon" class="text-7xl">ğŸ†</div>
            <div class="space-y-1">
                <h2 id="result-score" class="text-5xl font-black text-[#D97706]">0</h2>
                <p class="font-bold text-slate-400 uppercase tracking-widest">Total Points</p>
            </div>
            <p id="result-eval" class="text-lg font-medium px-4 text-slate-600"></p>
            <div class="flex flex-col gap-3 px-6">
                <button onclick="location.reload()" class="bg-[#3E5C3E] text-white py-4 rounded-2xl font-bold btn-active shadow-lg">å†æ¬¡ç‹©çµ</button>
            </div>
        </div>
    </main>

    <div id="note-panel" class="fixed-bottom bg-white border-t p-6 transform translate-y-full transition-transform duration-300 shadow-[0_-10px_30px_rgba(0,0,0,0.1)]">
        <div class="max-w-md mx-auto space-y-4">
            <div class="flex items-start gap-3">
                <div id="note-badge" class="mt-1 px-2 py-1 rounded text-[10px] font-black uppercase"></div>
                <div>
                    <h4 class="text-xs font-bold text-slate-400 mb-1">çµäººæé»</h4>
                    <p id="note-text" class="text-slate-700 text-sm leading-snug"></p>
                </div>
            </div>
            <button id="next-btn" onclick="nextQuestion()" class="w-full bg-[#2D3748] text-white py-4 rounded-2xl font-bold btn-active shadow-md">ä¸‹ä¸€é“çµç‰©</button>
        </div>
    </div>

    <script>
        // åª½åª½ï¼Œè«‹å¡«å…¥æ‚¨æ–°çš„ Google Sheet CSV é€£çµ
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTkqOrUWzTe8S6j13tUucGJuTHj_Lm3KRiciWJtf4SMbWCpg45o6E5KjzsZTxc1S17zoJ__h84aFLCT/pub?gid=0&single=true&output=csv';

        let allDB = [];
        let missionSet = [];
        let currIdx = 0;
        let score = 0;

        // åˆå§‹åŒ–ï¼šæŠ“å–é¡Œåº«
        async function init() {
            const msg = document.getElementById('load-msg');
            try {
                const res = await fetch(CSV_URL + '?t=' + Date.now());
                const csv = await res.text();
                parseDB(csv);
                msg.innerText = `çµç‰©åº«å·²å°±ç·’ï¼šå…±æœ‰ ${allDB.length} é …çŸ¥è­˜é»`;
            } catch (e) {
                msg.innerText = "âŒ çµå ´é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
            }
        }

        function parseDB(csv) {
            const rows = csv.split(/\r?\n/).filter(r => r.trim() !== "");
            const sep = csv.includes('\t') ? '\t' : ',';
            allDB = rows.slice(1).map(row => {
                const cols = row.split(sep).map(c => c.replace(/^"|"$/g, '').trim());
                return {
                    id: cols[0], cat: cols[1], q: cols[3], 
                    opts: [cols[4], cols[5], cols[6], cols[7]], 
                    ans: cols[8], note: cols[9]
                };
            }).filter(q => q.q && q.ans);
        }

        function startMission() {
            // 7-7-6 æŠ½é¡Œé‚è¼¯
            const sf = allDB.filter(q => q.cat === 'SF').sort(() => 0.5 - Math.random()).slice(0, 7);
            const sd = allDB.filter(q => q.cat === 'SD').sort(() => 0.5 - Math.random()).slice(0, 7);
            const mn = allDB.filter(q => q.cat === 'MN').sort(() => 0.5 - Math.random()).slice(0, 6);
            
            missionSet = [...sf, ...sd, ...mn].sort(() => 0.5 - Math.random());
            
            if (missionSet.length < 20) {
                alert("é¡Œåº«æ•¸é‡ä¸è¶³ 20 é¡Œï¼Œè«‹å…ˆå¢åŠ é¡Œç›®ï¼");
                return;
            }

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            document.getElementById('quiz-progress').classList.remove('hidden');
            loadQuestion();
        }

        function loadQuestion() {
            const q = missionSet[currIdx];
            document.getElementById('quiz-progress').innerText = `${currIdx + 1} / 20`;
            document.getElementById('q-text').innerText = q.q;
            
            const grid = document.getElementById('opts-grid');
            grid.innerHTML = '';
            q.opts.forEach(opt => {
                if(!opt) return;
                const btn = document.createElement('button');
                btn.className = "hunter-card option-btn p-4 rounded-2xl text-left font-medium";
                btn.innerText = opt;
                btn.onclick = () => checkAns(opt, q.ans, q.note, btn);
                grid.appendChild(btn);
            });
            hideNote();
        }

        function checkAns(selected, correct, note, btn) {
            const isCorrect = selected.includes(correct) || selected === correct;
            const badge = document.getElementById('note-badge');
            
            // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
            Array.from(document.getElementById('opts-grid').children).forEach(b => b.onclick = null);

            if (isCorrect) {
                score += 5;
                btn.classList.add('btn-correct');
                badge.innerText = "æ•ç²æˆåŠŸ";
                badge.className = "mt-1 px-2 py-1 rounded text-[10px] font-black bg-green-100 text-green-700";
            } else {
                btn.classList.add('btn-wrong');
                badge.innerText = "çµç‰©é€ƒè„«";
                badge.className = "mt-1 px-2 py-1 rounded text-[10px] font-black bg-red-100 text-red-700";
            }
            
            document.getElementById('note-text').innerText = note;
            showNote();
            
            if (currIdx === 19 && isCorrect) {
                // æœ€å¾Œä¸€é¡Œç­”å°å…ˆç‘å°èŠ±
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } });
            }
        }

        function nextQuestion() {
            currIdx++;
            if (currIdx < 20) {
                loadQuestion();
            } else {
                finishMission();
            }
        }

        function finishMission() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('quiz-progress').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('note-panel').classList.add('translate-y-full');
            
            document.getElementById('result-score').innerText = score;
            
            let eval = "";
            if (score >= 90) {
                eval = "å¤ªå¼·äº†ï¼ä½ æ˜¯èªæ—å‚³èªªçµäººï¼Œæœƒè€ƒåœ‹æ–‡é›£ä¸å€’ä½ ï¼";
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            } else if (score >= 70) {
                eval = "è¡¨ç¾å„ªç•°ï¼å†ç²¾é€²ä¸€äº›ï¼Œä½ å°±èƒ½æŒæ¡æ£®æ—çš„æ‰€æœ‰ç§˜å¯†ã€‚";
            } else {
                eval = "ç‹©çµå°šæœªæˆåŠŸï¼Œçµäººä»é ˆåŠªåŠ›ï¼å¤šçœ‹è§£ææ˜¯æˆé•·çš„æ·å¾‘ã€‚";
            }
            document.getElementById('result-eval').innerText = eval;
        }

        function showNote() { document.getElementById('note-panel').classList.remove('translate-y-full'); }
        function hideNote() { document.getElementById('note-panel').classList.add('translate-y-full'); }
        function goHome
