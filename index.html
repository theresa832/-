<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹æ–‡å½¢éŸ³ç¾©é—–é—œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* é˜²æ­¢æ‰‹æ©Ÿé¸å–æ–‡å­—å¹²æ“¾éŠæˆ² */
        body { -webkit-user-select: none; touch-action: manipulation; }
        .fixed-bottom { position: fixed; bottom: 0; left: 0; right: 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <nav class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center">
        <h1 class="font-bold text-lg" id="nav-title">å½¢éŸ³ç¾©å¤§æŒ‘æˆ°</h1>
        <div id="progress-tag" class="text-sm bg-blue-700 px-2 py-1 rounded hidden">1 / 10</div>
    </nav>

    <main class="container mx-auto p-4 pb-32">
        
        <div id="map-screen" class="space-y-6">
            <section id="category-SF" class="bg-white p-4 rounded-xl shadow">
                <h2 class="font-bold border-l-4 border-blue-500 pl-2 mb-4">å­—å½¢ (SF)</h2>
                <div class="flex gap-4" id="sf-levels"></div>
            </section>
            <section id="category-SD" class="bg-white p-4 rounded-xl shadow">
                <h2 class="font-bold border-l-4 border-green-500 pl-2 mb-4">å­—éŸ³ (SD)</h2>
                <div class="flex gap-4" id="sd-levels"></div>
            </section>
            <section id="category-MN" class="bg-white p-4 rounded-xl shadow">
                <h2 class="font-bold border-l-4 border-orange-500 pl-2 mb-4">å­—ç¾© (MN)</h2>
                <div class="flex gap-4" id="mn-levels"></div>
            </section>
        </div>

        <div id="quiz-screen" class="hidden">
            <div id="question-text" class="text-xl font-medium mb-8 mt-4 leading-relaxed text-center">æ­£åœ¨è¼‰å…¥é¡Œç›®...</div>
            <div id="options-grid" class="grid grid-cols-1 gap-3">
                </div>
        </div>

        <div id="result-screen" class="hidden text-center space-y-6 py-10">
            <div id="result-emoji" class="text-6xl">ğŸ‰</div>
            <h2 id="result-title" class="text-2xl font-bold">éé—œï¼</h2>
            <p id="result-desc" class="text-slate-600">ä½ çš„æ­£ç¢ºç‡ç‚º 0%</p>
            <div class="flex flex-col gap-3">
                <button onclick="restartLevel()" class="bg-blue-600 text-white py-3 rounded-lg font-bold">æŒ‘æˆ°ä¸‹ä¸€é—œ</button>
                <button onclick="goHome()" class="bg-slate-200 py-3 rounded-lg font-bold">å›åˆ°é—œå¡åœ°åœ–</button>
            </div>
        </div>
    </main>

    <div id="note-panel" class="fixed-bottom bg-white border-t border-slate-200 p-4 transform translate-y-full transition-transform duration-300 shadow-2xl">
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <span id="note-status" class="font-bold block mb-1">è§£æ</span>
                <p id="note-content" class="text-slate-600 text-sm leading-snug"></p>
            </div>
            <button onclick="nextQuestion()" class="ml-4 bg-blue-600 text-white px-6 py-2 rounded-full font-bold shadow-lg">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <script>
        // --- è¨­å®šèˆ‡è®Šæ•¸ ---
        const CSV_URL = 'questions.csv'; // é€™è£¡æ”¾ä½ çš„ GitHub é€£çµ
        let allQuestions = [];
        let currentQuiz = [];
        let currentIndex = 0;
        let correctCount = 0;
        let unlocked = JSON.parse(localStorage.getItem('unlocked_levels')) || { SF: 1, SD: 1, MN: 1 };

        // --- åˆå§‹åŒ–ï¼šæŠ“å–é›²ç«¯ CSV ---
        async function initApp() {
            try {
                const response = await fetch(CSV_URL);
                const data = await response.text();
                parseCSV(data);
                renderMap();
            } catch (err) {
                alert("é¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– CSV é€£çµã€‚");
            }
        }

        function parseCSV(text) {
            const rows = text.split('\n').slice(1);
            allQuestions = rows.map(row => {
                const cols = row.split('\t');
                return { id: cols[0], cat: cols[1], level: parseInt(cols[2]), q: cols[3], 
                         opts: [cols[4], cols[5], cols[6], cols[7]], correct: cols[8], note: cols[9] };
            });
        }

        // --- åœ°åœ–èˆ‡è§£é– ---
        function renderMap() {
            ['SF', 'SD', 'MN'].forEach(cat => {
                const container = document.getElementById(`${cat.toLowerCase()}-levels`);
                container.innerHTML = '';
                for (let i = 1; i <= 3; i++) {
                    const isLocked = i > unlocked[cat];
                    const btn = document.createElement('button');
                    btn.className = `w-12 h-12 rounded-full font-bold ${isLocked ? 'bg-slate-200 text-slate-400' : 'bg-blue-500 text-white shadow-lg'}`;
                    btn.innerHTML = isLocked ? 'ğŸ”’' : i;
                    if (!isLocked) btn.onclick = () => startQuiz(cat, i);
                    container.appendChild(btn);
                }
            });
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function startQuiz(cat, level) {
            currentQuiz = allQuestions.filter(q => q.cat === cat && q.level === level).slice(0, 10);
            currentIndex = 0;
            correctCount = 0;
            showScreen('quiz');
            loadQuestion();
        }

        function loadQuestion() {
            const q = currentQuiz[currentIndex];
            document.getElementById('progress-tag').innerText = `${currentIndex + 1} / ${currentQuiz.length}`;
            document.getElementById('progress-tag').classList.remove('hidden');
            document.getElementById('question-text').innerText = q.q;
            
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            q.opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "bg-white border-2 border-slate-200 p-4 rounded-xl text-left active:bg-slate-100 transition-all";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, q.correct, q.note, btn);
                grid.appendChild(btn);
            });
            hideNote();
        }

        function checkAnswer(selected, correct, note, btn) {
            const isCorrect = selected.includes(correct) || selected === correct;
            if (isCorrect) {
                correctCount++;
                btn.classList.add('border-green-500', 'bg-green-50');
                document.getElementById('note-status').innerText = "âœ… æ­£ç¢º";
                document.getElementById('note-status').className = "text-green-600 font-bold block mb-1";
            } else {
                btn.classList.add('border-red-500', 'bg-red-50');
                document.getElementById('note-status').innerText = "âŒ éŒ¯èª¤";
                document.getElementById('note-status').className = "text-red-600 font-bold block mb-1";
            }
            document.getElementById('note-content').innerText = note;
            showNote();
            // åœç”¨æ‰€æœ‰æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
            Array.from(document.getElementById('options-grid').children).forEach(b => b.onclick = null);
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuiz.length) {
                loadQuestion();
            } else {
                finishQuiz();
            }
        }

        function finishQuiz() {
            const accuracy = correctCount / currentQuiz.length;
            const cat = currentQuiz[0].cat;
            const level = currentQuiz[0].level;

            showScreen('result');
            document.getElementById('progress-tag').classList.add('hidden');
            document.getElementById('result-desc').innerText = `ä½ çš„æ­£ç¢ºç‡ç‚º ${accuracy * 100}% (${correctCount}/${currentQuiz.length})`;
            
            if (accuracy >= 0.8) {
                document.getElementById('result-title').innerText = "è§£é–æˆåŠŸï¼";
                if (level === unlocked[cat]) unlocked[cat]++;
                localStorage.setItem('unlocked_levels', JSON.stringify(unlocked));
            } else {
                document.getElementById('result-title').innerText = "å†è©¦ä¸€æ¬¡ï¼";
            }
        }

        // --- é€šç”¨å·¥å…· ---
        function showScreen(type) {
            document.getElementById('map-screen').classList.toggle('hidden', type !== 'map');
            document.getElementById('quiz-screen').classList.toggle('hidden', type !== 'quiz');
            document.getElementById('result-screen').classList.toggle('hidden', type !== 'result');
            if (type === 'map') hideNote();
        }

        function showNote() { document.getElementById('note-panel').classList.remove('translate-y-full'); }
        function hideNote() { document.getElementById('note-panel').classList.add('translate-y-full'); }
        function goHome() { renderMap(); showScreen('map'); }
        function restartLevel() { startQuiz(currentQuiz[0].cat, currentQuiz[0].level); }

        window.onload = initApp;
    </script>
</body>
</html>
