<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹æ–‡å½¢éŸ³ç¾©æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-user-select: none; touch-action: manipulation; }
        .fixed-bottom { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; }
        .btn-active:active { transform: scale(0.98); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <nav class="bg-indigo-600 text-white p-4 shadow-lg flex justify-between items-center sticky top-0 z-40">
        <div>
            <h1 class="font-bold text-lg leading-none">å½¢éŸ³ç¾©æŒ‘æˆ°</h1>
            <p id="level-indicator" class="text-xs opacity-80 mt-1">é€£ç·šä¸­...</p>
        </div>
        <div id="progress-tag" class="hidden bg-indigo-800 px-3 py-1 rounded-full text-sm font-mono">0 / 10</div>
    </nav>

    <main class="container mx-auto p-4 max-w-md">
        <div id="debug-info" class="hidden bg-red-100 p-4 rounded-lg text-red-800 text-xs mb-4 overflow-auto max-h-40 font-mono"></div>
        
        <div id="map-screen" class="space-y-6">
            <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="font-bold text-indigo-600 mb-4">å­—å½¢ (SF)</h2>
                <div class="flex gap-4" id="sf-levels"></div>
            </section>
            <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="font-bold text-emerald-600 mb-4">å­—éŸ³ (SD)</h2>
                <div class="flex gap-4" id="sd-levels"></div>
            </section>
            <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <h2 class="font-bold text-orange-600 mb-4">å­—ç¾© (MN)</h2>
                <div class="flex gap-4" id="mn-levels"></div>
            </section>
        </div>

        <div id="quiz-screen" class="hidden py-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 mb-6 min-h-[120px] flex items-center justify-center">
                <div id="question-text" class="text-xl font-bold text-center leading-relaxed"></div>
            </div>
            <div id="options-grid" class="grid grid-cols-1 gap-4"></div>
        </div>

        <div id="result-screen" class="hidden text-center py-12 space-y-8">
            <div id="result-emoji" class="text-8xl">ğŸŠ</div>
            <h2 id="result-title" class="text-3xl font-black">æŒ‘æˆ°æˆåŠŸï¼</h2>
            <p id="result-desc" class="text-slate-500 text-lg font-medium"></p>
            <div class="flex flex-col gap-4 px-6">
                <button onclick="restartOrNext()" class="bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg shadow-xl btn-active">ç¹¼çºŒæŒ‘æˆ°</button>
                <button onclick="goHome()" class="bg-white text-slate-500 py-4 rounded-2xl font-bold border border-slate-200 btn-active">å›åˆ°åœ°åœ–</button>
            </div>
        </div>
    </main>

    <div id="note-panel" class="fixed-bottom bg-white border-t p-5 transform translate-y-full transition-transform duration-300 shadow-2xl">
        <div class="flex flex-col space-y-4">
            <div class="flex items-center">
                <div id="note-badge" class="px-2 py-0.5 rounded text-xs font-bold mr-2"></div>
                <div id="note-content" class="text-slate-700 font-medium text-sm"></div>
            </div>
            <button onclick="nextQuestion()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold btn-active">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <script>
        // ç¢ºä¿é€™æ˜¯æ‚¨çš„ CSV é€£çµ
        const CSV_URL =https://docs.google.com/spreadsheets/d/e/2PACX-1vSM7wqwBK2VVRNeYJQoRHq94GiySwkGOP68ywRsy699w-MAcHDmNkRo5OuU84cRIZ7MjnMsjNmqF5DA/pub?output=csv;

        let allQuestions = [];
        let currentQuiz = [];
        let currentIndex = 0;
        let correctCount = 0;
        let unlocked = JSON.parse(localStorage.getItem('unlocked_levels_v2')) || { SF: 1, SD: 1, MN: 1 };

        async function initApp() {
            const indicator = document.getElementById('level-indicator');
            const debugBox = document.getElementById('debug-info');
            try {
                const response = await fetch(CSV_URL + '&t=' + Date.now());
                const data = await response.text();
                
                // è¨ºæ–·ï¼šå¦‚æœæŠ“ä¸åˆ°æ±è¥¿æˆ–æŠ“åˆ° HTML
                if (data.length < 50) throw new Error("æŠ“åˆ°çš„è³‡æ–™å¤ªçŸ­ï¼Œè«‹ç¢ºèªè¡¨æ ¼å…§æ˜¯å¦æœ‰è³‡æ–™");
                if (data.includes("<!DOCTYPE")) throw new Error("æŠ“åˆ°çš„æ˜¯ç¶²é è€Œéè³‡æ–™ï¼Œè«‹ç¢ºèªæ˜¯å¦é¸å°ã€ŒCSVã€æ ¼å¼");

                parseData(data);
                
                if (allQuestions.length === 0) throw new Error("ç„¡æ³•è§£æé¡Œç›®ï¼Œè«‹æª¢æŸ¥è¡¨æ ¼æ¬„ä½é †åº");

                renderMap();
                indicator.innerText = "è«‹é¸æ“‡é—œå¡";
            } catch (err) {
                indicator.innerText = "âŒ è®€å–å¤±æ•—";
                debugBox.classList.remove('hidden');
                debugBox.innerText = "éŒ¯èª¤è¨ºæ–·ï¼š" + err.message + "\n\næŠ“å–åˆ°çš„å‰100å­—ï¼š\n" + data.substring(0, 100);
            }
        }

        function parseData(text) {
            const rows = text.split(/\r?\n/).filter(r => r.trim() !== "");
            // è‡ªå‹•åµæ¸¬åˆ†éš”ç¬¦ï¼šå˜—è©¦ Tab, å˜—è©¦é€—è™Ÿ
            const firstRow = rows[0];
            let sep = ",";
            if (firstRow.includes('\t')) sep = '\t';

            allQuestions = rows.slice(1).map((row, index) => {
                const cols = row.split(sep).map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length < 9) return null;
                return {
                    id: cols[0], cat: cols[1], level: parseInt(cols[2]) || 1,
                    q: cols[3], opts: [cols[4], cols[5], cols[6], cols[7]], 
                    correct: cols[8], note: cols[9] || ""
                };
            }).filter(q => q && q.q && q.correct);
            console.log("Loaded:", allQuestions.length);
        }

        function renderMap() {
            ['SF', 'SD', 'MN'].forEach(cat => {
                const container = document.getElementById(`${cat.toLowerCase()}-levels`);
                if (!container) return;
                container.innerHTML = '';
                for (let i = 1; i <= 3; i++) {
                    const isLocked = i > unlocked[cat];
                    const btn = document.createElement('button');
                    btn.className = `w-14 h-14 rounded-2xl font-black text-xl transition-all btn-active ${isLocked ? 'bg-slate-100 text-slate-300' : 'bg-white border-2 border-indigo-100 text-indigo-600 shadow-sm'}`;
                    btn.innerHTML = isLocked ? 'ğŸ”’' : i;
                    if (!isLocked) btn.onclick = () => startQuiz(cat, i);
                    container.appendChild(btn);
                }
            });
        }

        function startQuiz(cat, level) {
            const filtered = allQuestions.filter(q => q.cat === cat && q.level === level);
            if(filtered.length === 0) {
                alert(`Level ${level} æš«ç„¡é¡Œç›®ï¼è«‹ç¢ºèªè¡¨æ ¼ä¸­çš„ cat æ¬„ä½æ˜¯å¦ç‚º ${cat}`);
                return;
            }
            currentQuiz = filtered.sort(() => Math.random() - 0.5).slice(0, 10);
            currentIndex = 0; correctCount = 0;
            document.getElementById('level-indicator').innerText = `${cat} - Level ${level}`;
            showScreen('quiz'); loadQuestion();
        }

        function loadQuestion() {
            const q = currentQuiz[currentIndex];
            document.getElementById('progress-tag').innerText = `${currentIndex + 1} / ${currentQuiz.length}`;
            document.getElementById('progress-tag').classList.remove('hidden');
            document.getElementById('question-text').innerText = q.q;
            const grid = document.getElementById('options-grid'); grid.innerHTML = '';
            q.opts.forEach(opt => {
                if(!opt) return;
                const btn = document.createElement('button');
                btn.className = "bg-white border border-slate-200 p-4 rounded-2xl text-left font-medium btn-active shadow-sm";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, q.correct, q.note, btn);
                grid.appendChild(btn);
            });
            hideNote();
        }

        function checkAnswer(selected, correct, note, btn) {
            const isCorrect = selected.includes(correct) || selected === correct;
            const badge = document.getElementById('note-badge');
            if (isCorrect) {
                correctCount++;
                btn.classList.add('bg-emerald-50', 'border-emerald-500', 'text-emerald-700');
                badge.innerText = "æ­£ç¢º"; badge.className = "px-2 py-0.5 rounded text-xs font-bold mr-2 bg-emerald-100 text-emerald-700";
            } else {
                btn.classList.add('bg-rose-50', 'border-rose-500', 'text-rose-700');
                badge.innerText = "éŒ¯èª¤"; badge.className = "px-2 py-0.5 rounded text-xs font-bold mr-2 bg-rose-100 text-rose-700";
            }
            document.getElementById('note-content').innerText = note || "åŠ æ²¹ï¼";
            showNote();
            Array.from(document.getElementById('options-grid').children).forEach(b => b.onclick = null);
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuiz.length) loadQuestion(); else finishQuiz();
        }

        function finishQuiz() {
            const accuracy = correctCount / currentQuiz.length;
            const cat = currentQuiz[0].cat; const level = currentQuiz[0].level;
            showScreen('result');
            document.getElementById('progress-tag').classList.add('hidden');
            document.getElementById('result-desc').innerText = `æ­£ç¢ºç‡ ${Math.round(accuracy * 100)}% (${correctCount}/${currentQuiz.length})`;
            if (accuracy >= 0.8) {
                document.getElementById('result-title').innerText = "æŒ‘æˆ°æˆåŠŸï¼";
                if (level === unlocked[cat] && level < 3) unlocked[cat]++;
                localStorage.setItem('unlocked_levels_v2', JSON.stringify(unlocked));
            } else {
                document.getElementById('result-title').innerText = "å†è©¦ä¸€æ¬¡ï¼";
            }
        }

        function showScreen(type) {
            document.getElementById('map-screen').classList.toggle('hidden', type !== 'map');
            document.getElementById('quiz-screen').classList.toggle('hidden', type !== 'quiz');
            document.getElementById('result-screen').classList.toggle('hidden', type !== 'result');
        }

        function showNote() { document.getElementById('note-panel').classList.remove('translate-y-full'); }
        function hideNote() { document.getElementById('note-panel').classList.add('translate-y-full'); }
        function goHome() { renderMap(); showScreen('map'); }
        function restartOrNext() {
            const cat = currentQuiz[0].cat; const level = currentQuiz[0].level;
            if (correctCount / currentQuiz.length >= 0.8 && level < 3) startQuiz(cat, level + 1);
            else startQuiz(cat, level);
        }

        window.onload = initApp;
    </script>
</body>
</html>
